/*!
 * 
 *
 * Home     
 * Author   
 * License  GPL 2 (http://www.gnu.org/licenses/gpl.html)
 */
var mikio_bScroll               = false;
var mikio_oWindow               = null;
var mikio_iTocChangePoint       = -1;
var mikio_iTocChangePointOffset = 0;//48;
var mikio_oToc                  = null;
var mikio_iTocTop               = 0;
var mikio_iTocRight             = 0;
var mikio_bTocFloating          = false;
var mikio_bTocUserHide          = false;
var mikio_bScrollFirst          = true;
var mikio_oScrollInterval       = -1;
var mikio_iScrollIntervalCnt    = 0;
var mikio_bResize               = false;
var mikio_oResizeInterval       = -1;
var mikio_iResizeIntervalCnt    = 0;
var mikio_oNavToggle            = null;
var mikio_oNavCollapse          = null;


jQuery(document).ready(function() {
    mikio_oWindow       = jQuery(window);
    mikio_oToc          = jQuery('.mikio-toc');
    mikio_oNavToggle    = jQuery('.mikio-navbar-toggle');
    mikio_oNavCollapse  = jQuery('.mikio-navbar-collapse');

    mikio_iTocChangePoint = jQuery('.mikio-content').offset().top - mikio_iTocChangePointOffset;

    // mikio_iTocRight = mikio_oWindow.width() - (mikio_oToc.offset().left + mikio_oToc.outerWidth());
    // mikio_iTocTop = mikio_oToc.offset().top - jQuery('.mikio-content').offset().top + mikio_iTocChangePointOffset;
    mikio_iTocRight = mikio_oWindow.width() - (jQuery('article').offset().left + jQuery('article').outerWidth());
    mikio_iTocTop = jQuery('article').offset().top - jQuery('.mikio-content').offset().top + mikio_iTocChangePointOffset;

    mikio_bTocFloating = mikio_oToc.hasClass('float');

    jQuery('.mikio-sidebar-toggle').on('mousedown', function(e) {
        if(jQuery(this).hasClass('closed')) {
            jQuery(this).removeClass('closed');
            jQuery(this).siblings('.mikio-sidebar-collapse').slideDown(150, function() {
                jQuery(this).removeClass('closed');
            });
        } else {
            jQuery(this).addClass('closed');
            jQuery(this).siblings('.mikio-sidebar-collapse').slideUp(150, function() {
                jQuery(this).addClass('closed');
                jQuery(this).css('display', '');
            });
        }
    });

    jQuery('.mikio-navbar-toggle').on('mousedown', function() {
        jQuery('.mikio-navbar-collapse').slideToggle(250);
    });

    jQuery(window).scroll(function() {
        mikio_bScroll = true;
        mikio_iScrollIntervalCnt = 0;
    
        if(mikio_oScrollInterval == -1) {
            mikio_oScrollInterval = setInterval(function() {
                mikio_scrollInterval();
            }, 100);
        }
    });
        
    jQuery(window).resize(function() {
        mikio_bResize = true;
        mikio_iResizeIntervalCnt = 0;
    
        if(mikio_oResizeInterval == -1) {
            mikio_oResizeInterval = setInterval(function() {
                mikio_resizeInterval();
            }, 100);
        }
    });
});



function mikio_scrollInterval() {
    mikio_iScrollIntervalCnt++;
    if(mikio_iScrollIntervalCnt > 20) {
        clearInterval(mikio_oScrollInterval);
        mikio_oScrollInterval = -1;
    }

    if(mikio_bScroll) {
        var scrollTop = mikio_oWindow.scrollTop();
        mikio_bScroll = false;

        if(mikio_iTocChangePoint != -1 && scrollTop >= mikio_iTocChangePoint && mikio_bTocFloating == false) {
            mikio_bTocFloating = true;

            if(!mikio_oToc.find('#dw__toc h3').hasClass('closed')) {
                mikio_bTocUserHide = false;
                mikio_toggleToc(false);
            } else {
                mikio_bTocUserHide = true;
            }
            

            mikio_oToc.addClass('float').css({
                'right':    mikio_iTocRight + 'px',
                'top':      mikio_iTocTop + 'px'
            });
        }

        if(mikio_iTocChangePoint != -1 && scrollTop <= mikio_iTocChangePoint && mikio_bTocFloating == true) {
            mikio_bTocFloating = false;
            mikio_oToc.removeClass('float');

            if(!mikio_bTocUserHide) {
                mikio_toggleToc(true);
            }
        }

        mikio_bScrollFirst = false;
    }
}


function mikio_toggleToc(state) {
    var hideToc = function() {
        mikio_oToc.find('#dw__toc h3').addClass('closed').removeClass('open');
        mikio_oToc.find('#dw__toc h3').children('strong').html('<span>+</span>');
        mikio_oToc.find('#dw__toc > div').children().css('display', 'none').attr('aria-expanded', 'false');    
    };

    var showToc = function() {
        mikio_oToc.find('#dw__toc h3').addClass('open').removeClass('closed');
        mikio_oToc.find('#dw__toc h3').children('strong').html('<span>-</span>');
        mikio_oToc.find('#dw__toc > div').children().css('display', '').attr('aria-expanded', 'true');
    }

    if(mikio_bScrollFirst) {
        if(state === false) {
            hideToc();
        }
    } else {
        if(state === false) {
            mikio_oToc.find('#dw__toc > div').slideUp(250, function() {
                hideToc();
            });
        } else if(state === true) {
            showToc();
            mikio_oToc.find('#dw__toc > div').slideDown(250);
        }
    }
}


function mikio_resizeInterval() {
    mikio_iResizeIntervalCnt++;
    if(mikio_iResizeIntervalCnt > 20) {
        clearInterval(mikio_oResizeInterval);
        mikio_oResizeInterval = -1;
    }

    if(mikio_bResize) {
        mikio_bResize = false;
        mikio_iTocChangePoint = jQuery('.mikio-content').offset().top - mikio_iTocChangePointOffset;

        if(mikio_oNavToggle.is(':hidden') && mikio_oNavCollapse.is(':hidden')) {
            mikio_oNavCollapse.css('display', 'flex');
        }

        if(!mikio_oNavToggle.is(':hidden')) {
            mikio_oNavCollapse.css('display', '');
        }
    }
}